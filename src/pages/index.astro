---
import Table from "./_table.astro";
import FormOpenButton from "./_form-open-button.astro";
import AddTransactionForm from "./_add-transaction-form.astro";
import Layout from "./_layout.astro";
import { css } from "css";
import { getPagedTransactions } from "lib/server";

const props = await getPagedTransactions({});
---

<Layout>
	<div
		class={css({
			height: "90vh",
		})}
	>
		<Table transactions={props.data} hasNext={props.hasNext} />
	</div>
	<form-handler>
		<FormOpenButton />
		<AddTransactionForm />
	</form-handler>
</Layout>

<style>
	@keyframes tempBgColorChange {
		from {
			background-color: #d9f99d;
		}
	}
</style>

<script>
	import type { TransactionDao } from "lib/client";

	class FormHandler extends HTMLElement {
		constructor() {
			super();

			const formOpenDiv = this.querySelector("div") as HTMLDivElement;

			const formOpenButton = this.querySelector(
				"div > button",
			) as HTMLButtonElement;

			const dialog = this.querySelector("dialog") as HTMLDialogElement;

			const form = this.querySelector("form") as HTMLFormElement;

			function createAnchor(data: any) {
				const a = document.createElement("a");

				a.setAttribute("href", `/transactions/${data.id}`);

				a.innerHTML = `
					<span>${data.date}</span>
					<span>${data.description}</span>
					<span>${data.amount}</span>
				`;

				a.style.animation = "tempBgColorChange 0.8s ease-in-out forwards";

				return a;
			}

			function getDateFromAnchorElement(a: HTMLAnchorElement) {
				const span = a.querySelector("span") as HTMLSpanElement;
				return new Date(span.textContent!);
			}

			function closeDialog() {
				setTimeout(() => {
					dialog.close();
					formOpenDiv.style.display = "flex";
				}, 100);
			}

			formOpenButton.addEventListener("click", () => {
				setTimeout(() => {
					formOpenDiv.style.display = "none";
					dialog.showModal();
				}, 100);
			});

			form.addEventListener("submit", async (event) => {
				event.preventDefault();

				const formData = new FormData(form);
				const tmp = Object.fromEntries(formData.entries());
				const data = { ...tmp, amount: Number(tmp.amount) } as TransactionDao;

				const table = this.querySelector(".table") as HTMLDivElement;
				const allRows = table.getElementsByTagName("a");

				const { id } = await fetch("/api/transactions.json", {
					method: "POST",
					headers: { "Content-Type": "application/json" },
					body: JSON.stringify(data),
				}).then((response) => response.json());

				const a = createAnchor({ id, ...data });

				let inserted = false;

				for (const r of allRows) {
					const date = getDateFromAnchorElement(r);

					if (new Date(data.date) >= date) {
						table.insertBefore(a, r);

						a.scrollIntoView({
							block: "center",
							behavior: "instant",
						});

						closeDialog();

						inserted = true;

						return;
					}
				}

				if (!inserted) {
					table.appendChild(a);

					closeDialog();

					return;
				}
			});

			dialog.addEventListener("click", (event) => {
				if (event.target === dialog) {
					closeDialog();
				}
			});
		}
	}

	customElements.define("form-handler", FormHandler);
</script>
